{"version":3,"file":"tasks-4ACMqUQQ.js","sources":["../../../.svelte-kit/adapter-node/chunks/tasks.js"],"sourcesContent":["import { w as writable } from \"./index2.js\";\nimport cron, { CronJob } from \"cron\";\nimport { u as updateMarketplaceApps, t as throttle } from \"./marketplaces.js\";\nimport { d as deleteExpiredSessions } from \"./auth.js\";\nimport { l as logger } from \"./appdata.js\";\nconst tasks = [\n  {\n    // t('tasks.update-marketplace-apps') This is for i18next to automatically create a locale file entry\n    id: \"update-marketplace-apps\",\n    schedule: \"*/30 * * * *\",\n    runImmediately: true,\n    handler: updateMarketplaceApps,\n    stats: getDefaultStats(\"*/30 * * * *\")\n  },\n  {\n    // t('tasks.delete-expired-sessions') This is for i18next to automatically create a locale file entry\n    id: \"delete-expired-sessions\",\n    schedule: \"0 0 1 * *\",\n    runImmediately: false,\n    handler: deleteExpiredSessions,\n    stats: getDefaultStats(\"0 0 1 * *\")\n  }\n];\nfunction getDefaultStats(schedule) {\n  return writable({\n    progress: 0,\n    running: false,\n    lastExecution: void 0,\n    lastDuration: void 0,\n    nextExecution: cron.sendAt(schedule).toJSDate()\n  });\n}\nasync function scheduleTasks() {\n  for (const task of tasks) {\n    logger.info(`Scheduling task \"${task.id}\" to run on schedule \"${task.schedule}\"`);\n    const job = new CronJob(task.schedule, async () => await executeTask(task));\n    job.start();\n    if (task.runImmediately) {\n      await executeTask(task);\n    }\n  }\n}\nasync function executeTask(task) {\n  const { id, schedule, handler, stats } = task;\n  logger.info(`Starting task \"${id}\"`);\n  stats.update((stats2) => ({ ...stats2, progress: 0, running: true }));\n  const lastExecution = /* @__PURE__ */ new Date();\n  try {\n    await handler(throttle((p) => stats.update((s) => ({ ...s, progress: p }))));\n  } catch (error) {\n    logger.error(`Error running task \"${id}\":`, error);\n  }\n  const lastDuration = (/* @__PURE__ */ new Date()).getTime() - lastExecution.getTime();\n  stats.update(() => ({\n    progress: 1,\n    running: false,\n    lastExecution,\n    lastDuration,\n    nextExecution: cron.sendAt(schedule).toJSDate()\n  }));\n  logger.info(`Completed task \"${id}\" in ${lastDuration}ms`);\n}\nexport {\n  executeTask as e,\n  scheduleTasks as s,\n  tasks as t\n};\n"],"names":[],"mappings":"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"}