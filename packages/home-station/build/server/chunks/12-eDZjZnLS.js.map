{"version":3,"file":"12-eDZjZnLS.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/setup/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/12.js"],"sourcesContent":["import { r as redirect, f as fail } from \"../../../chunks/index.js\";\nimport { eq } from \"drizzle-orm\";\nimport { d as db, u as users, h as hostnames, c as containerEngines } from \"../../../chunks/db.js\";\nimport { l as lucia } from \"../../../chunks/auth.js\";\nimport dns from \"node:dns/promises\";\nimport http from \"node:http\";\nimport { a as testLocalConnection, t as testRemoteConnection } from \"../../../chunks/containerengines.js\";\nimport { generateId } from \"lucia\";\nimport bcrypt from \"bcrypt\";\nasync function getPublicIp() {\n  return new Promise((resolve, reject) => {\n    http.get({ host: \"api.ipify.org\", port: 80, path: \"/\" }, (resp) => {\n      resp.on(\"data\", (ip) => {\n        resolve(String(ip));\n      });\n      resp.on(\"error\", reject);\n    });\n  });\n}\nasync function detectHostnames() {\n  try {\n    return await dns.reverse(await getPublicIp());\n  } catch (error) {\n    return [];\n  }\n}\nconst load = async () => {\n  const hasUsers = !!await db.query.users.findFirst();\n  if (hasUsers) {\n    return redirect(303, \"/\");\n  }\n  const detectedHostnames = await detectHostnames();\n  return { detectedHostnames };\n};\nconst actions = {\n  signup: async ({ request, cookies }) => {\n    const data = await request.formData();\n    const username = data.get(\"username\")?.toString();\n    const password = data.get(\"password\")?.toString();\n    const language = data.get(\"language\")?.toString();\n    const domainsAndHostnames = data.get(\"hostnames\")?.toString()?.split(\",\") ?? [];\n    if (!username || !/[a-zA-Z0-9_]{4,31}/.test(username)) {\n      return fail(400, { username, invalid: true });\n    }\n    if (!password || password.length < 8 || password.length > 255) {\n      return fail(400, { password: \"password\", invalid: true });\n    }\n    if (!language || ![\"en\", \"de\"].includes(language)) {\n      return fail(400, { language, invalid: true });\n    }\n    const usernameExists = !!await db.query.users.findFirst({\n      where: eq(users.username, username.toLowerCase())\n    });\n    if (usernameExists) {\n      return fail(400, { username, exists: true });\n    }\n    try {\n      const hostnameValues = domainsAndHostnames.map((h) => ({ host: h }));\n      await db.insert(hostnames).values(hostnameValues).onConflictDoNothing();\n      const userId = generateId(15);\n      const hashedPassword = await bcrypt.hash(password, 10);\n      await db.insert(users).values({\n        id: userId,\n        username: username.toLowerCase(),\n        hashedPassword,\n        language,\n        theme: \"skeleton\"\n      });\n      const session = await lucia.createSession(userId, {});\n      const sessionCookie = lucia.createSessionCookie(session.id);\n      cookies.set(sessionCookie.name, sessionCookie.value, {\n        path: \".\",\n        ...sessionCookie.attributes\n      });\n    } catch (e) {\n      return fail(500, {\n        message: \"An unknown error occurred\"\n      });\n    }\n    return redirect(302, \"/\");\n  },\n  async connectLocal({ request }) {\n    try {\n      const data = await request.formData();\n      const name = data.get(\"name\")?.toString();\n      let socketPath = data.get(\"socketPath\")?.toString();\n      if (!name) {\n        return fail(400, { type: \"local\", name, missing: true });\n      }\n      if (!socketPath)\n        socketPath = void 0;\n      const engine = await testLocalConnection(socketPath);\n      await db.insert(containerEngines).values({\n        id: 1,\n        name,\n        type: \"local\",\n        socketPath,\n        host: void 0,\n        ca: void 0,\n        cert: void 0,\n        key: void 0\n      }).onConflictDoUpdate({\n        target: containerEngines.id,\n        set: {\n          name,\n          type: \"local\",\n          socketPath,\n          host: void 0,\n          ca: void 0,\n          cert: void 0,\n          key: void 0\n        }\n      });\n      return { type: \"local\", success: true, hostname: (await engine.info())?.Name };\n    } catch (e) {\n      return { type: \"local\", error: String(e) };\n    }\n  },\n  async connectRemote({ request }) {\n    try {\n      const data = await request.formData();\n      const name = data.get(\"name\")?.toString();\n      const host = data.get(\"host\")?.toString();\n      let ca = await data.get(\"ca\")?.text();\n      let cert = await data.get(\"cert\")?.text();\n      let key = await data.get(\"key\")?.text();\n      if (!name) {\n        return fail(400, { type: \"remote\", name, missing: true });\n      }\n      if (!host) {\n        return fail(400, { type: \"remote\", host, missing: true });\n      }\n      if (!ca)\n        ca = void 0;\n      if (!cert)\n        cert = void 0;\n      if (!key)\n        key = void 0;\n      const engine = await testRemoteConnection(host, ca, cert, key);\n      await db.insert(containerEngines).values({\n        id: 1,\n        name,\n        type: \"remote\",\n        socketPath: void 0,\n        host,\n        ca,\n        cert,\n        key\n      }).onConflictDoUpdate({\n        target: containerEngines.id,\n        set: {\n          name,\n          type: \"remote\",\n          socketPath: void 0,\n          host,\n          ca,\n          cert,\n          key\n        }\n      });\n      return { type: \"remote\", success: true, hostname: (await engine.info())?.Name };\n    } catch (e) {\n      return { type: \"remote\", error: String(e) };\n    }\n  }\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/setup/_page.server.ts.js';\n\nexport const index = 12;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/setup/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/setup/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/12.u-2PegFl.js\",\"_app/immutable/chunks/scheduler.bQlOXBkt.js\",\"_app/immutable/chunks/index.dknh01mB.js\",\"_app/immutable/chunks/each.anRlpCm9.js\",\"_app/immutable/chunks/ProgressBar.svelte_svelte_type_style_lang.JlGIzIKZ.js\",\"_app/immutable/chunks/index.5bRYXlS8.js\",\"_app/immutable/chunks/transitions.bjOOOgyG.js\",\"_app/immutable/chunks/spread.rEx3vLA9.js\",\"_app/immutable/chunks/Icon.9NkTZT6r.js\",\"_app/immutable/chunks/plus.qIUUgd4x.js\",\"_app/immutable/chunks/i18n.Mah0M8rZ.js\",\"_app/immutable/chunks/forms.uhvzcuB7.js\",\"_app/immutable/chunks/entry.qbHVI6p7.js\",\"_app/immutable/chunks/stores.Xz95ZHQI.js\"];\nexport const stylesheets = [\"_app/immutable/assets/ProgressBar.oq5aOWfL.css\"];\nexport const fonts = [];\n"],"names":["db"],"mappings":"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"}