{"version":3,"file":"marketplaces-Hf_qDRv9.js","sources":["../../../.svelte-kit/adapter-node/chunks/marketplaces.js"],"sourcesContent":["import fs from \"node:fs/promises\";\nimport { pull, clone } from \"isomorphic-git\";\nimport http from \"isomorphic-git/http/node/index.js\";\nimport path from \"node:path\";\nimport yaml from \"js-yaml\";\nimport { d as db, m as marketplaceApps, b as marketplaces } from \"./db.js\";\nimport { g as getAppDataPath, l as logger } from \"./appdata.js\";\nimport \"i18next\";\nimport \"i18next-browser-languagedetector\";\nimport \"cronstrue/locales/en.js\";\nimport \"cronstrue/locales/de.js\";\nimport { eq } from \"drizzle-orm\";\nasync function exists(path2) {\n  try {\n    await fs.access(path2, fs.constants.F_OK);\n    return true;\n  } catch {\n    return false;\n  }\n}\nfunction throttle(callback, delay = 1e3) {\n  let throttleTimeout = null;\n  let storedArgs = null;\n  const throttledCallback = (...args) => {\n    storedArgs = args;\n    const shouldExecuteCallback = !throttleTimeout;\n    if (shouldExecuteCallback) {\n      callback(...storedArgs);\n      storedArgs = null;\n      throttleTimeout = setTimeout(() => {\n        throttleTimeout = null;\n        if (storedArgs) {\n          throttledCallback(...storedArgs);\n        }\n      }, delay);\n    }\n  };\n  return throttledCallback;\n}\nconst appDataPath = await getAppDataPath();\nconst marketplacesPath = path.join(appDataPath, \"marketplaces\");\nawait fs.mkdir(marketplacesPath, { recursive: true });\nfunction getMarketplacePath(marketplace) {\n  return path.join(marketplacesPath, marketplace.id);\n}\nfunction getMarketplaceAppPath(app) {\n  return path.join(marketplacesPath, app.marketplaceId, \"apps\", app.appId);\n}\nasync function deleteMarketplace(id) {\n  const deletedMarketplace = await db.delete(marketplaces).where(eq(marketplaces.id, id)).returning();\n  for (const marketplace of deletedMarketplace) {\n    const marketplacePath = getMarketplacePath(marketplace);\n    await fs.rm(marketplacePath, { recursive: true, force: true });\n  }\n}\nasync function updateMarketplaceApps(progress) {\n  const marketplaces2 = await db.query.marketplaces.findMany();\n  const apps = [];\n  for (const marketplace of marketplaces2) {\n    const appIds = await pullMarketplaceRepository(marketplace, progress);\n    for (const appId of appIds) {\n      try {\n        const marketplacePath = getMarketplacePath(marketplace);\n        const appYamlPath = path.join(marketplacePath, \"apps\", appId, \"app.yml\");\n        const app = await loadAppFromFiles(appYamlPath);\n        apps.push({\n          appId: app.id,\n          marketplaceId: marketplace.id,\n          ...app\n        });\n      } catch (e) {\n        logger.warn(e);\n      }\n    }\n  }\n  await db.delete(marketplaceApps);\n  await db.insert(marketplaceApps).values(apps);\n}\nasync function pullMarketplaceRepository(marketplace, progress) {\n  const marketplacePath = getMarketplacePath(marketplace);\n  const onAuth = () => ({\n    username: marketplace.gitUsername ?? void 0,\n    password: marketplace.gitPassword ?? void 0\n  });\n  const onProgress = (event) => {\n    if (event.total) {\n      progress(event.loaded / event.total);\n    } else {\n      progress(void 0);\n    }\n  };\n  const author = { name: \"Home Station\" };\n  const repoExists = await exists(path.join(marketplacePath, \".git\"));\n  if (repoExists) {\n    logger.info(`Pulling \"${marketplace.gitRemoteUrl}\" to \"${marketplacePath}\"`);\n    await pull({ fs, http, dir: marketplacePath, onAuth, onProgress, author });\n  } else {\n    logger.info(`Cloning \"${marketplace.gitRemoteUrl}\" to \"${marketplacePath}\"`);\n    await clone({\n      fs,\n      http,\n      dir: marketplacePath,\n      url: marketplace.gitRemoteUrl,\n      onAuth,\n      onProgress\n    });\n  }\n  try {\n    const appsPath = path.join(marketplacePath, \"apps\");\n    return await fs.readdir(appsPath);\n  } catch {\n    logger.warn(`No \"apps\" directory found in \"${marketplacePath}\"! Skipping...`);\n    return [];\n  }\n}\nasync function loadAppFromFiles(appYamlPath) {\n  if (!await exists(appYamlPath)) {\n    throw new Error(`No app.yml found in \"${appYamlPath}! Skipping...\"`);\n  }\n  const appYaml = await fs.readFile(appYamlPath, \"utf8\");\n  return yaml.load(appYaml);\n}\nexport {\n  deleteMarketplace as d,\n  getMarketplaceAppPath as g,\n  throttle as t,\n  updateMarketplaceApps as u\n};\n"],"names":["db"],"mappings":";;;;;;;;;;;;;AAYA,eAAe,MAAM,CAAC,KAAK,EAAE;AAC7B,EAAE,IAAI;AACN,IAAI,MAAM,EAAE,CAAC,MAAM,CAAC,KAAK,EAAE,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;AAC9C,IAAI,OAAO,IAAI,CAAC;AAChB,GAAG,CAAC,MAAM;AACV,IAAI,OAAO,KAAK,CAAC;AACjB,GAAG;AACH,CAAC;AACD,SAAS,QAAQ,CAAC,QAAQ,EAAE,KAAK,GAAG,GAAG,EAAE;AACzC,EAAE,IAAI,eAAe,GAAG,IAAI,CAAC;AAC7B,EAAE,IAAI,UAAU,GAAG,IAAI,CAAC;AACxB,EAAE,MAAM,iBAAiB,GAAG,CAAC,GAAG,IAAI,KAAK;AACzC,IAAI,UAAU,GAAG,IAAI,CAAC;AACtB,IAAI,MAAM,qBAAqB,GAAG,CAAC,eAAe,CAAC;AACnD,IAAI,IAAI,qBAAqB,EAAE;AAC/B,MAAM,QAAQ,CAAC,GAAG,UAAU,CAAC,CAAC;AAC9B,MAAM,UAAU,GAAG,IAAI,CAAC;AACxB,MAAM,eAAe,GAAG,UAAU,CAAC,MAAM;AACzC,QAAQ,eAAe,GAAG,IAAI,CAAC;AAC/B,QAAQ,IAAI,UAAU,EAAE;AACxB,UAAU,iBAAiB,CAAC,GAAG,UAAU,CAAC,CAAC;AAC3C,SAAS;AACT,OAAO,EAAE,KAAK,CAAC,CAAC;AAChB,KAAK;AACL,GAAG,CAAC;AACJ,EAAE,OAAO,iBAAiB,CAAC;AAC3B,CAAC;AACD,MAAM,WAAW,GAAG,MAAM,cAAc,EAAE,CAAC;AAC3C,MAAM,gBAAgB,GAAG,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,cAAc,CAAC,CAAC;AAChE,MAAM,EAAE,CAAC,KAAK,CAAC,gBAAgB,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;AACtD,SAAS,kBAAkB,CAAC,WAAW,EAAE;AACzC,EAAE,OAAO,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,WAAW,CAAC,EAAE,CAAC,CAAC;AACrD,CAAC;AACD,SAAS,qBAAqB,CAAC,GAAG,EAAE;AACpC,EAAE,OAAO,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,GAAG,CAAC,aAAa,EAAE,MAAM,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC;AAC3E,CAAC;AACD,eAAe,iBAAiB,CAAC,EAAE,EAAE;AACrC,EAAE,MAAM,kBAAkB,GAAG,MAAMA,IAAE,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,YAAY,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC;AACtG,EAAE,KAAK,MAAM,WAAW,IAAI,kBAAkB,EAAE;AAChD,IAAI,MAAM,eAAe,GAAG,kBAAkB,CAAC,WAAW,CAAC,CAAC;AAC5D,IAAI,MAAM,EAAE,CAAC,EAAE,CAAC,eAAe,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;AACnE,GAAG;AACH,CAAC;AACD,eAAe,qBAAqB,CAAC,QAAQ,EAAE;AAC/C,EAAE,MAAM,aAAa,GAAG,MAAMA,IAAE,CAAC,KAAK,CAAC,YAAY,CAAC,QAAQ,EAAE,CAAC;AAC/D,EAAE,MAAM,IAAI,GAAG,EAAE,CAAC;AAClB,EAAE,KAAK,MAAM,WAAW,IAAI,aAAa,EAAE;AAC3C,IAAI,MAAM,MAAM,GAAG,MAAM,yBAAyB,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC;AAC1E,IAAI,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE;AAChC,MAAM,IAAI;AACV,QAAQ,MAAM,eAAe,GAAG,kBAAkB,CAAC,WAAW,CAAC,CAAC;AAChE,QAAQ,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,CAAC,CAAC;AACjF,QAAQ,MAAM,GAAG,GAAG,MAAM,gBAAgB,CAAC,WAAW,CAAC,CAAC;AACxD,QAAQ,IAAI,CAAC,IAAI,CAAC;AAClB,UAAU,KAAK,EAAE,GAAG,CAAC,EAAE;AACvB,UAAU,aAAa,EAAE,WAAW,CAAC,EAAE;AACvC,UAAU,GAAG,GAAG;AAChB,SAAS,CAAC,CAAC;AACX,OAAO,CAAC,OAAO,CAAC,EAAE;AAClB,QAAQ,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AACvB,OAAO;AACP,KAAK;AACL,GAAG;AACH,EAAE,MAAMA,IAAE,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC;AACnC,EAAE,MAAMA,IAAE,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AAChD,CAAC;AACD,eAAe,yBAAyB,CAAC,WAAW,EAAE,QAAQ,EAAE;AAChE,EAAE,MAAM,eAAe,GAAG,kBAAkB,CAAC,WAAW,CAAC,CAAC;AAC1D,EAAE,MAAM,MAAM,GAAG,OAAO;AACxB,IAAI,QAAQ,EAAE,WAAW,CAAC,WAAW,IAAI,KAAK,CAAC;AAC/C,IAAI,QAAQ,EAAE,WAAW,CAAC,WAAW,IAAI,KAAK,CAAC;AAC/C,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,UAAU,GAAG,CAAC,KAAK,KAAK;AAChC,IAAI,IAAI,KAAK,CAAC,KAAK,EAAE;AACrB,MAAM,QAAQ,CAAC,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC;AAC3C,KAAK,MAAM;AACX,MAAM,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;AACvB,KAAK;AACL,GAAG,CAAC;AACJ,EAAE,MAAM,MAAM,GAAG,EAAE,IAAI,EAAE,cAAc,EAAE,CAAC;AAC1C,EAAE,MAAM,UAAU,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,MAAM,CAAC,CAAC,CAAC;AACtE,EAAE,IAAI,UAAU,EAAE;AAClB,IAAI,MAAM,CAAC,IAAI,CAAC,CAAC,SAAS,EAAE,WAAW,CAAC,YAAY,CAAC,MAAM,EAAE,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC;AACjF,IAAI,MAAM,IAAI,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,GAAG,EAAE,eAAe,EAAE,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,CAAC,CAAC;AAC/E,GAAG,MAAM;AACT,IAAI,MAAM,CAAC,IAAI,CAAC,CAAC,SAAS,EAAE,WAAW,CAAC,YAAY,CAAC,MAAM,EAAE,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC;AACjF,IAAI,MAAM,KAAK,CAAC;AAChB,MAAM,EAAE;AACR,MAAM,IAAI;AACV,MAAM,GAAG,EAAE,eAAe;AAC1B,MAAM,GAAG,EAAE,WAAW,CAAC,YAAY;AACnC,MAAM,MAAM;AACZ,MAAM,UAAU;AAChB,KAAK,CAAC,CAAC;AACP,GAAG;AACH,EAAE,IAAI;AACN,IAAI,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,MAAM,CAAC,CAAC;AACxD,IAAI,OAAO,MAAM,EAAE,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;AACtC,GAAG,CAAC,MAAM;AACV,IAAI,MAAM,CAAC,IAAI,CAAC,CAAC,8BAA8B,EAAE,eAAe,CAAC,cAAc,CAAC,CAAC,CAAC;AAClF,IAAI,OAAO,EAAE,CAAC;AACd,GAAG;AACH,CAAC;AACD,eAAe,gBAAgB,CAAC,WAAW,EAAE;AAC7C,EAAE,IAAI,CAAC,MAAM,MAAM,CAAC,WAAW,CAAC,EAAE;AAClC,IAAI,MAAM,IAAI,KAAK,CAAC,CAAC,qBAAqB,EAAE,WAAW,CAAC,cAAc,CAAC,CAAC,CAAC;AACzE,GAAG;AACH,EAAE,MAAM,OAAO,GAAG,MAAM,EAAE,CAAC,QAAQ,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC;AACzD,EAAE,OAAO,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;AAC5B;;;;"}